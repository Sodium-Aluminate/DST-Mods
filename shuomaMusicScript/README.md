
这个脚本是为了[饥荒联机版](https://store.steampowered.com/app/322330)的 Mod 角色 [烁玛](https://steamcommunity.com/workshop/filedetails/?id=2754469576)自动弹奏乐曲而写的 bash 脚本
## 依赖环境
X
xte
bash
date
sed

## 作者测试时的环境

`GNU bash 5.1.16(1)-release (x86_64-pc-linux-gnu)`
`date (GNU coreutils) 9.0`
`xte v1.09`
`sed (GNU sed) 4.8`
`gnome 42.0`

gnome 配置了使用 xorg 而非 wayland，因为后者没有找到对应的工具。

## 编写乐谱

### mod 说明

在该 mod 中，按下 `12347890` 按键分别代表 C4 到 C5，而控制按键 `b`、`n`、`c`、`v` 分别代表升调、降调、升八度、降八度。

这意味着该 mod 内可行的乐谱范围为 Bb2(`bc1`) 到 Cb6(`nv0`)。

如果你目标的铺子超过了上限或下限，你可以试试看整体升/降调；如果铺子范围同时超过上限和下限，那么你只能换一首歌或者请求作者更新 mod 了。

### 乐谱格式
乐谱文件(**S**huo**M**a **K**ey **Q**ueue file)应保存为 `<歌名>.smkq`，格式为纯文本文件，换行符应为 Unix 换行符（`\n`而不是`\r\n`）。<del>实际上这些要求都不是硬性的，你要是不遵守说不定也能用。</del>

乐谱开头应写明 BPM=<一个正数>，注意：与正常的音乐不同，由于没有做出半拍的区分，因此“一拍”是写谱最小的时间单位。
* 这导致大部分乐谱都需要 BPM 翻倍才能使播放速度正常；
* 对于有半拍的曲子，BPM 可能需要乘以 4，每拍之间额外间隔一行用来放半拍；
```
BPM=200
```

如果有多个 BPM 需要衔接，请依次解析多个乐谱。

乐谱文件每行表示一个节拍所需要按下的按键，如：
```
1 3 7
```
表示同时按下 1、3、7 三个键盘按键，在游戏中表示为一个基本的 C 和弦。

如果需要一个长音，请增加对应的空行，如：
```
7

1
2
3
4
7

1

1

```
（节选自[小步舞曲 ](https://en.wikipedia.org/wiki/Minuets_in_G_major_and_G_minor)）

## 配置脚本
由于游戏内同时按下多个按键的时候，如果一个是升降调/高低八度而另一个不是，那么就有很大的概率出现混乱。因此必须先按下一个按键，然后松开对应的控制按键，再按下另一个。但是由于 xte 并不会告诉脚本是否执行完成，因此唯一的解决方案就是等待一会儿，并且断定它完成了。

这很明显会带来一个问题：等待时间太少，可能对应的按键还没有完成；等待时间太多，和弦会不和谐。而这个时间的长短很明显取决于电脑性能。因此，建议进阶用户打开脚本，在确保电脑后台没有高占用的情况下，修改 KeyDelay 的值并不断试验是否出现跑调（某个音过高/过低/高八度/低八度）或者吃音（某个音完全没有发出）的情况。

当然，为了防止前一拍影响后一拍，请同时确保每一拍 `((和弦数+1)*KeyDelay)<(60/BPM*该拍后面空拍数)`。如果实在做不到的话，可能只能考虑降低 BPM 或者求助于 libtas 了。

## 食用方法
`<脚本位置> <乐谱.smkq>`
